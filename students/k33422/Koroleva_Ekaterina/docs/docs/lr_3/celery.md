# Celery

Celery - это асинхронная очередь задач на основе распределенного обмена сообщениями. Она используется для обработки
ресурсоемких или длительных задач в фоновом режиме, позволяя веб-приложению быстро реагировать на запросы пользователей. Celery
поддерживает выполнение задач в реальном времени или их планирование на будущее.

## Основные концепции Celery

1. **Задачи (Tasks)**: Задачи - это единицы работы, которые выполняются Celery. Они определяются как функции Python, которые
   могут быть вызваны асинхронно. Задачи могут принимать аргументы и возвращать результаты.

2. **Воркеры (Workers)**: Воркеры - это процессы или узлы, которые выполняют задачи. Они получают задачи из очереди, выполняют
   их и возвращают результаты. Celery поддерживает горизонтальное масштабирование воркеров для обработки большого количества
   задач.

3. **Брокеры сообщений (Message Brokers)**: Брокеры сообщений используются для обмена сообщениями между клиентами и воркерами
   Celery. Они обеспечивают надежную доставку задач и результатов. Примерами брокеров сообщений являются Redis, RabbitMQ и
   Apache Kafka.

4. **Бэкенды результатов (Result Backends)**: Бэкенды результатов используются для хранения результатов выполненных задач. Они
   позволяют клиентам получать результаты задач после их завершения. Примерами бэкендов результатов являются Redis, RabbitMQ и
   базы данных.

## Объяснение Celery

```python
from celery import Celery

app = Celery(
    'celery_app',
    broker='redis://redis:6379/0',
    backend='redis://redis:6379/0',
)
```

- Создается экземпляр приложения Celery с именем `'celery_app'`.
- В качестве брокера сообщений и бэкенда результатов используется Redis, работающий в контейнере Docker с именем `redis` на
  порту 6379 и в базе данных 0.

```python
@app.task
def parse(url):
    doc = requests.get(url, headers={'User-Agent': 'Mozilla/5.0'}).text
    data = extract_data(doc)
    for i in data:
        insert_data(i)

    return data
```

- Определяется задача `parse` с помощью декоратора `@app.task`.
- Задача принимает URL-адрес в качестве аргумента.
- Внутри задачи выполняется HTTP-запрос к указанному URL-адресу с использованием библиотеки `requests`.
- Полученный HTML-документ передается функции `extract_data` для извлечения данных.
- Извлеченные данные сохраняются в базе данных с помощью функции `insert_data`.
- Задача возвращает извлеченные данные.

## Объяснение FastAPI

```python
@router.post('/parse', response_model=Annotated[TaskResponse, Depends()])
async def parse(url: Annotated[TaskRequest, Body()]):
    task = celery_parse.delay(url.url)
    return TaskResponse(id=task.id, status='PENDING')
```

- Определяется маршрут `/parse` с помощью декоратора `@router.post`.
- Маршрут принимает объект `TaskRequest` в теле запроса, который содержит URL-адрес для парсинга.
- Вызывается задача Celery `parse` с помощью метода `delay`, передавая URL-адрес в качестве аргумента.
- Метод `delay` запускает задачу асинхронно и возвращает объект `AsyncResult`, представляющий задачу.
- Возвращается объект `TaskResponse`, содержащий идентификатор задачи и статус "PENDING" (в ожидании выполнения).

```python
@router.get('/check/{pk}', response_model=Annotated[TaskResponse, Depends()])
async def check(pk: Annotated[str, Path()]):
    task = celery_parse.AsyncResult(pk)
    return TaskResponse(id=task.id, status=task.status)
```

- Определяется маршрут `/check/{pk}` с помощью декоратора `@router.get`.
- Маршрут принимает идентификатор задачи `pk` в качестве параметра пути.
- Создается объект `AsyncResult` с помощью метода `celery_parse.AsyncResult`, передавая идентификатор задачи.
- Возвращается объект `TaskResponse`, содержащий идентификатор задачи и ее текущий статус.

```python
@router.get('/result/{pk}')
async def result(pk: Annotated[str, Path()]):
    task = celery_parse.AsyncResult(pk)

    return {'data': task.result}
```

- Определяется маршрут `/result/{pk}` с помощью декоратора `@router.get`.
- Маршрут принимает идентификатор задачи `pk` в качестве параметра пути.
- Создается объект `AsyncResult` с помощью метода `celery_parse.AsyncResult`, передавая идентификатор задачи.
- Возвращается словарь, содержащий результат выполнения задачи под ключом `'data'`.
